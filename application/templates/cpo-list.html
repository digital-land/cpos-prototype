{% extends "dlf-base.html" %}

{% from "./govuk-jinja-components/back-link/macro.jinja" import govukBackLink %}
{% block beforeContent %}
{{ super() }}

{{ govukBackLink({
  "text": "See summary of CPO data",
  "href": url_for('frontend.dashboard')
}) }}
{% endblock %}

{% block content %}

	<h1 class="govuk-heading-xl">
	  Compulsory purchase orders
	</h1>

	<div class="govuk-grid-row">

		<div class="govuk-grid-column-one-third">
			<h3 class="govuk-heading-m">Filters</h3>

			<form action="" class="govuk-form">

				<div class="govuk-form-group">
				  <label class="govuk-label" for="year">
					Year
				  </label>
				  <input class="govuk-input" id="year" name="year" type="text" {% if request.args['year'] %}value="{{ request.args['year'] }}"{% endif %}>
				</div>

				{% macro dlfFilterGroup(params) %}
					<details class="filter-group" {% if params.is_open %}open{% endif %}>
						<summary class="filter-group__summary"><h3 class="govuk-heading-s filter-group__heading">{{ params.title }}</h3>
							{%- if params.selected %}<span class="filter-group__selected-text">{{ params.selected }} selected</span>{% endif -%}
							<svg version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="filter-group__icon filter-group__icon--up"><path d="m798.16 609.84l-256-256c-16.683-16.683-43.691-16.683-60.331 0l-256 256c-16.683 16.683-16.683 43.691 0 60.331s43.691 16.683 60.331 0l225.84-225.84 225.84 225.84c16.683 16.683 43.691 16.683 60.331 0s16.683-43.691 0-60.331z"></path></svg>
							<svg version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="filter-group__icon filter-group__icon--down"><path d="m225.84 414.16l256 256c16.683 16.683 43.691 16.683 60.331 0l256-256c16.683-16.683 16.683-43.691 0-60.331s-43.691-16.683-60.331 0l-225.84 225.84-225.84-225.84c-16.683-16.683-43.691-16.683-60.331 0s-16.683 43.691 0 60.331z"></path></svg>
						</summary>
						<fieldset class="govuk-fieldset filter-group__fieldset">
							<legend class="govuk-fieldset__legend govuk-fieldset__legend--m govuk-visually-hidden">
							  <h1 class="govuk-fieldset__heading">
								{{ params.title }}
							  </h1>
							</legend>
							{{ caller() }}
						</fieldset>
					</details>
				{% endmacro %}

				<div class="govuk-form-group">
					{% call dlfFilterGroup({
						"title": "Investigation",
						"is_open": True if request.args['investigation'] else False,
						"selected": 1 if request.args['investigation'] else 0
					}) %}
					<div class="govuk-radios">
					  <div class="govuk-radios__item">
						<input class="govuk-radios__input" id="investigation-yes" name="investigation" type="radio" value="true" {% if request.args['investigation'] in ['True', 'true', 't'] %}checked=checked{% endif %}>
						<label class="govuk-label govuk-radios__label" for="investigation-yes">
						  Has
						</label>
					  </div>
					  <div class="govuk-radios__item">
						<input class="govuk-radios__input" id="investigation-no" name="investigation" type="radio" value="false" {% if request.args['investigation'] in ['False', 'false', 'f'] %}checked=checked{% endif %}>
						<label class="govuk-label govuk-radios__label" for="investigation-no">
						  Doesn't have
						</label>
					  </div>
					</div>
					{% endcall %}
				</div>


				<div class="govuk-form-group">
					{% call dlfFilterGroup({
						"title": "CPO type",
						"is_open": True if request.args['type'] else False,
						"selected": request.args.getlist('type')|length if request.args['type'] else 0
					}) %}
					<div class="govuk-checkboxes">
					  <div class="govuk-checkboxes__item">
						<input class="govuk-checkboxes__input" id="cpo-type-1" name="type" type="checkbox" value="housing" {% if 'housing' in request.args.getlist('type') %}checked=checked{% endif %}>
						<label class="govuk-label govuk-checkboxes__label" for="cpo-type-1">
						  Housing
						</label>
					  </div>
					  <div class="govuk-checkboxes__item">
						<input class="govuk-checkboxes__input" id="cpo-type-2" name="type" type="checkbox" value="planning" {% if 'planning' in request.args.getlist('type') %}checked=checked{% endif %}>
						<label class="govuk-label govuk-checkboxes__label" for="cpo-type-2">
						  Planning
						</label>
					  </div>
					  <div class="govuk-checkboxes__item">
						<input class="govuk-checkboxes__input" id="cpo-type-3" name="type" type="checkbox" value="development corporation" {% if request.args['type'] == 'development corporation' %}checked=checked{% endif %}>
						<label class="govuk-label govuk-checkboxes__label" for="cpo-type-3">
						  Development corporation
						</label>
					  </div>
					  <div class="govuk-checkboxes__item">
						<input class="govuk-checkboxes__input" id="cpo-type-4" name="type" type="checkbox" value="GLA" {% if request.args['type'] == 'GLA' %}checked=checked{% endif %}>
						<label class="govuk-label govuk-checkboxes__label" for="cpo-type-4">
						  GLA
						</label>
					  </div>
					</div>
					{% endcall %}
				</div>


				<div class="govuk-form-group">
					{% call dlfFilterGroup({
						"title": "CPO status",
						"is_open": True if request.args['current_status'] else False,
						"selected": 1 if request.args['current_status'] else 0
					}) %}
					<div class="govuk-radios">
					{% for status in cpo_statuses %}
						<div class="govuk-radios__item">
							<input class="govuk-radios__input" id="cpo-status-{{ loop.index }}" name="current_status" type="radio" value="{{ status }}" {% if request.args['current_status']|trim == status %}checked=checked{% endif %}>
							{#- To INVESTIGATE: had to add |trim because withdrawn was coming through with space at the end -#}
							<label class="govuk-label govuk-radios__label" for="cpo-status-{{ loop.index }}">
							  {{ status }}
							</label>
					  </div>
					{% endfor %}
					</div>
					{% endcall %}
				</div>


				<div class="govuk-form-group">
					{% call dlfFilterGroup({
						"title": "Organisation",
						"is_open": True if request.args['org'] else False,
						"selected": request.args.getlist('org')|length if request.args['org'] else 0
					}) %}
					<div class="govuk-checkboxes">
					{% for la in las %}
						<div class="govuk-checkboxes__item">
							<input class="govuk-checkboxes__input" id="local-authority-{{ loop.index}}" name="org" type="checkbox" value="{{ la[0] }}" {% if request.args['org'] == la[0] %}checked=checked{% endif %}>
							<label class="govuk-label govuk-checkboxes__label" for="local-authority-{{ loop.index }}">
							  {{ la[1] }}
							</label>
					  	</div>
					{% endfor %}
					</div>
					{% endcall %}
				</div>

				<button type="submit" class="govuk-button" data-module="govuk-button">
				  Apply filter
				</button>
				<a class="link-align-btn" href="{{ url_for('frontend.cpo_list') }}">Clear</a>

			</form>
		</div>

		<div class="govuk-grid-column-two-thirds">
			<p class="govuk-body">Showing {{ cpos|length }} results {% if request.args['year'] %} for {{ request.args['year'] }}{% endif %}</p>

			<div class="applied-filters">
				{% if request.args and request.args['investigation'] %}
				<div class="applied-filter__group">
					<span class="applied-filter__name govuk-!-font-weight-bold">Investigation:</span>
					<span class="applied-filter__item">{{ request.args['investigation'] }}</span>
				</div>
				{% endif %}
				{% if request.args and request.args['type'] %}
				<div class="applied-filter__group">
					<span class="applied-filter__name govuk-!-font-weight-bold">Type:</span>
					{% for type_ in request.args.getlist('type') %}
					<span class="applied-filter__item">{{ type_ }}</span>
					{% endfor %}
				</div>
				{% endif %}
				{% if request.args and request.args['current_status'] %}
				<div class="applied-filter__group">
					<span class="applied-filter__name govuk-!-font-weight-bold">Current status:</span>
					<span class="applied-filter__item">{{ request.args['current_status'] }}</span>
				</div>
				{% endif %}
				{% if request.args and request.args['org'] %}
				<div class="applied-filter__group">
					<span class="applied-filter__name govuk-!-font-weight-bold">Organisation:</span>
					{% for org in request.args.getlist('org') %}
					<span class="applied-filter__item">{{ org|map_la_code_to_name }}</span>
					{% endfor %}
				</div>
				{% endif %}
			</div>

			<ul class="govuk-list cpo-list">
			{% for cpo in cpos %}
				<li class="cpo-item">
					{% set cpo_status = cpo.latest_status().status %}
					<span class="govuk-tag {{ cpo_status | map_cpo_status_to_tag_class }}">{{ cpo_status }}</span>
					<h4 class="govuk-heading-m cpo-item__title"><a href="{{ url_for('frontend.cpo', id=cpo.compulsory_purchase_order) }}">{{ cpo.compulsory_purchase_order }}</a></h4>
					<div class="cpo-item__org">{{ cpo.organisation | map_la_code_to_name }}</div>
					<div>Issue date: {{ cpo.start_date }}</div>
					<div>Type: {{ cpo.compulsory_purchase_order_type }}</div>
					<div>Address: {{ cpo.name }}</div>
				</li>
			{% endfor %}
			</ul>
		</div>

	</div>

	

{% endblock %}
